<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Dozentenblatt ‚Äì Modul-Autofill</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, sans-serif; }
    fieldset { border: 1px solid #ddd; border-radius: 8px; padding: 12px; margin-bottom: 16px; }
    legend { padding: 0 6px; font-weight: 600; }
    .stack { display: grid; gap: 6px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    label { font-weight: 600; }
    table { width: 100%; }
    th, td { padding: 4px; }
    .muted { color: #666; font-size: 12px; }
    .btn { padding: 6px 10px; border-radius: 6px; border: 1px solid #ccc; background: #f7f7f7; cursor: pointer; }
    .btn:active { transform: translateY(1px); }
    .btn-primary { background: #0ea5e9; border-color: #0284c7; color: #fff; }
    #modulSelect { width: 100%; height: 12rem; }
    #moduleFilter { width: 100%; }
  </style>
</head>
<body>
  <h1>üìÑ Dozentenblatt</h1>

  <form method="POST" action="/submit?type=dozent" class="stack">

    <!-- =========================
         Modul-Auswahl (aus JSON)
         ========================= -->
    <fieldset>
      <legend>Stammdaten</legend>
      <div class="row">
        <div class="stack">
          <label>Abgabetermin DS:</label>
          <input name="abgabetermin" type="date">
        </div>
        <div class="stack">
          <label>Eingang bei DS:</label>
          <input name="eingang">
        </div>
      </div>

      <div class="row">
        <div class="stack">
          <label>Hochschule:</label>
          <input name="hochschule" value="HTWK Leipzig" disabled>
        </div>
        <div class="stack">
          <label>Semester:</label>
          <select name="semester" id="semester"></select>
        </div>
      </div>

      <div class="row">
        <div class="stack">
          <label>Titel:</label>
          <select name="titel" id="titel"></select>
        </div>
        <div class="stack">
          <label>Fakult√§t:</label>
          <select name="fakultaet" id="fakultaet"></select>
        </div>
      </div>

      <div class="row">
        <div class="stack">
          <label>Vorname:</label>
          <input name="vorname">
        </div>
        <div class="stack">
          <label>Name:</label>
          <input name="name">
        </div>
      </div>

      <div class="row">
        <div class="stack">
          <label>E-Mail:</label>
          <input name="email">
        </div>
        <div class="stack">
          <label>Telefon:</label>
          <input name="telefon">
        </div>
      </div>

      <div class="stack">
        <label>Arbeitszeit:</label>
        <select name="arbeitszeit">
          <option value="Vollzeit">Vollzeit</option>
          <option value="Teilzeit">Teilzeit</option>
          <option value="Gast">Gast</option>
        </select>
      </div>
    </fieldset>

    <fieldset>
      <legend>Durchzuf√ºhrende Lehrveranstaltungen</legend>
      <p class="muted">Hinweis: W√§hle in der Spalte <b>Modulnr.</b> ein Modul aus ‚Äì die restlichen Felder werden automatisch vorgeschlagen.</p>
      <div id="einsatzTabelle"></div>
      <button type="button" id="einsatzAddBtn" class="btn">Einsatz hinzuf√ºgen</button>
    </fieldset>

    <fieldset>
      <legend>Hinweise & Mitteilungen</legend>
      <div id="hinweisTabelle"></div>
      <button type="button" id="hinweisAddBtn" class="btn">Zeile hinzuf√ºgen</button>
    </fieldset>

    <fieldset>
      <legend>Regelm√§√üig m√∂gliche Einsatzzeiten f√ºr <u>externe</u> Dozenten</legend>
      <div id="einsatzzeitTabelle"></div>
      <button type="button" id="einsatzzeitAddBtn" class="btn">Zeile hinzuf√ºgen</button>
    </fieldset>

    <fieldset>
      <legend>Notwendige regelm√§√üige Sperrzeiten f√ºr <u>interne</u> Dozenten</legend>
      <div id="sperrzeitTabelle"></div>
      <button type="button" id="sperrzeitAddBtn" class="btn">Zeile hinzuf√ºgen</button>
    </fieldset>

    <fieldset>
      <legend>Dozenten-/Forschungstag (nur bei Vollzeit)</legend>
      <div id="dfTagTabelle"></div>
      <small>Hinweis: D = Dozententag; F = Forschungstag ‚Üí jeweils nur <b>einmal</b> ausw√§hlen!</small>
    </fieldset>

    <button type="submit" class="btn btn-primary">‚úÖ Speichern</button>
  </form>

  <p><a href="/">Zur√ºck zur Auswahl</a></p>

  <!-- =========================
       Inline-JavaScript
       ========================= -->

  <!-- semester.js -->
  <script>
    function getCurrentSemester() {
      const now = new Date();
      const month = now.getMonth() + 1;
      const year = now.getFullYear();
      if (month >= 4 && month <= 9) {
        return `Sommersemester ${year}`;
      } else if (month >= 10) {
        const wsJahr1 = year;
        const wsJahr2 = (year + 1).toString().slice(-2);
        return `Wintersemester ${wsJahr1}/${wsJahr2}`;
      } else {
        const wsJahr1 = year - 1;
        const wsJahr2 = year.toString().slice(-2);
        return `Wintersemester ${wsJahr1}/${wsJahr2}`;
      }
    }

    function fillSemesterList(selectId = 'semester', yearsBack = 5, yearsForward = 10) {
      const now = new Date();
      const currentYear = now.getFullYear();
      const startYear = currentYear - yearsBack;
      const endYear = currentYear + yearsForward;
      const semesterList = [];

      for (let y = startYear; y <= endYear; y++) {
        semesterList.push(`Sommersemester ${y}`);
        const wsJahr2 = (y + 1).toString().slice(-2);
        semesterList.push(`Wintersemester ${y}/${wsJahr2}`);
      }

      const select = document.getElementById(selectId);
      if (!select) return;
      const currentSemester = getCurrentSemester();
      semesterList.forEach(sem => {
        const opt = document.createElement('option');
        opt.value = sem;
        opt.textContent = sem;
        if (sem === currentSemester) opt.selected = true;
        select.appendChild(opt);
      });
    }

    function setSemesterFromTurnus(turnus) {
      if (!turnus) return;
      const s = document.getElementById('semester');
      if (!s) return;
      const now = new Date();
      let target = '';
      if (turnus.toLowerCase().startsWith('winter')) {
        const y = (now.getMonth()+1 >= 10) ? now.getFullYear() : now.getFullYear()-1;
        target = `Wintersemester ${y}/${(y+1).toString().slice(-2)}`;
      } else if (turnus.toLowerCase().startsWith('sommer')) {
        target = `Sommersemester ${now.getFullYear()}`;
      }
      const opt = Array.from(s.options).find(o => o.textContent === target);
      if (opt) s.value = opt.value;
    }

    document.addEventListener('DOMContentLoaded', () => fillSemesterList());
  </script>

  <!-- titel.js -->
  <script>
    const titelListe = [
      "", "Prof.", "Prof. Dr.", "Prof. Dr. med.", "Prof. Dr. med. dent.", "Prof. Dr. rer. nat.",
      "Prof. Dr. rer. pol.", "Prof. Dr. rer. oec.", "Prof. Dr. rer. soc.", "Prof. Dr.-Ing.",
      "Prof. Dr. jur.", "Prof. Dr. phil.", "Prof. Dr. habil.", "Prof. Dr. oec.", "Prof. Dr. agr.",
      "Prof. Dr. theol.", "Prof. Dr. vet. med.", "Prof. Dr. rer. agr.", "Prof. Dr. rer. medic.",
      "Prof. Dipl.-Ing.", "Prof. Mag.", "Prof. Mag. rer. nat.", "Priv.-Doz. Dr.",
      "Priv.-Doz. Dr. habil.", "Dr.", "Dr. h.c.", "Dr. med.", "Dr. med. dent.", "Dr. med. vet.",
      "Dr. rer. nat.", "Dr. rer. pol.", "Dr. rer. oec.", "Dr. rer. soc.", "Dr. rer. agr.",
      "Dr. jur.", "Dr. phil.", "Dr.-Ing.", "Dr. theol.", "Dr. oec.", "Dr. agr.", "Dr. habil.",
      "Dipl.-Ing.", "Dipl.-Wirt.-Ing.", "Dipl.-Kfm.", "Dipl.-Soz.-P√§d.", "Dipl.-Psych.",
      "Dipl.-Volksw.", "Dipl.-Betriebsw.", "Dipl.-Biol.", "Mag.", "Mag. rer. nat.", "Mag. theol.",
      "B. Sc.", "B. A.", "M. Sc.", "M. A.", "M. Eng.", "M. Ed.", "M. Med.", "MBA", "LL.B.", "LL.M.",
      "Ass. jur.", "Ass. iur.", "Staatsexamen", "B. Eng.", "M. Arch.", "B. Ed.", "Dipl.-P√§d.",
      "Dr. rer. medic.", "Ph.D.", "D.Phil.", "MD", "D.Sc.", "D.Litt.", "D.Eng.", "Dr. sc. agr.",
      "Dr. sc. hum.", "Dr. sc. nat."
    ];

    function fillTitelList(selectId = "titel", list = titelListe) {
      const select = document.getElementById(selectId);
      if (!select) return;
      select.innerHTML = "";
      list.forEach(titel => {
        const opt = document.createElement('option');
        opt.value = titel;
        opt.textContent = titel;
        select.appendChild(opt);
      });
    }

    document.addEventListener('DOMContentLoaded', () => fillTitelList());
  </script>

  <!-- fakultaet.js -->
  <script>
    const fakultaetListe = [
      "",
      "FAS",
      "FB",
      "FDIT",
      "FIM",
      "FING",
      "FWW",
      "HSZ",
      "MNZ",
      "Gast",
      "HonProf"
    ];

    function fillFakultaetList(selectId = "fakultaet", list = fakultaetListe) {
      const select = document.getElementById(selectId);
      if (!select) return;
      select.innerHTML = "";
      list.forEach(fak => {
        const opt = document.createElement("option");
        opt.value = fak;
        opt.textContent = fak;
        select.appendChild(opt);
      });
    }

    document.addEventListener("DOMContentLoaded", () => fillFakultaetList());
  </script>

  <!-- einsaetze.js (mit Autofill-Unterst√ºtzung) -->
  <script>
    let einsatzZaehler = 0;

    document.addEventListener("DOMContentLoaded", function() {
      document.getElementById("einsatzAddBtn").addEventListener("click", () => addEinsatzRow());
      addEinsatzRow(); // eine leere Start-Zeile
    });

    function ensureEinsatzTable() {
      if (!document.getElementById("einsatzTable")) addEinsatzRow();
    }

    function clearEinsatzTable() {
      const table = document.getElementById("einsatzTable");
      if (!table) return;
      while (table.rows.length > 2) table.deleteRow(-1); // 2 Kopfzeilen behalten
      renumberEinsatzRows();
    }

    function addEinsatzRow(preset = {}) {
      const tableDiv = document.getElementById("einsatzTabelle");

      if (!document.getElementById("einsatzTable")) {
        tableDiv.innerHTML = `
          <table border="1" style="border-collapse:collapse;" id="einsatzTable">
            <tr>
              <th rowspan="2">lfd</th>
              <th rowspan="2">Fakult√§t</th>
              <th rowspan="2">Stg.</th>
              <th rowspan="2">FS</th>
              <th rowspan="2">Gruppe</th>
              <th rowspan="2">Modulnr.</th>
              <th rowspan="2">Modulname</th>
              <th colspan="3">Reale SWS (Pr√§senz)</th>
              <th rowspan="2">digital</th>
              <th rowspan="2">Bemerkung</th>
              <th rowspan="2">L√∂schen</th>
            </tr>
            <tr>
              <th>V</th>
              <th>S</th>
              <th>P</th>
            </tr>
          </table>
        `;
      }

      const table = document.getElementById("einsatzTable");
      const row = table.insertRow(-1);

      row.innerHTML = `
        <td></td>
        <td><input name="einsatz_fakultaet_" style="width:80px"></td>
        <td><input name="einsatz_stg_" style="width:60px"></td>
        <td><input name="einsatz_fs_" style="width:35px"></td>
        <td><input name="einsatz_gruppe_" style="width:70px"></td>
        <td>
          <select name="einsatz_modulnr_" class="modulnr-select" style="width:120px">
            <option value="">‚Äì w√§hlen ‚Äì</option>
          </select>
        </td>
        <td><input name="einsatz_modulname_" style="width:220px"></td>
        <td><input name="einsatz_sws_v_" type="number" min="0" step="0.5" style="width:50px"></td>
        <td><input name="einsatz_sws_s_" type="number" min="0" step="0.5" style="width:50px"></td>
        <td><input name="einsatz_sws_p_" type="number" min="0" step="0.5" style="width:50px"></td>
        <td>
          <select name="einsatz_digital_">
            <option value=""></option>
            <option value="ja">ja</option>
            <option value="nein">nein</option>
          </select>
        </td>
        <td><input name="einsatz_bemerkung_" style="width:220px"></td>
        <td><button type="button" class="btn" onclick="removeEinsatzRow(this)">üóëÔ∏è</button></td>
      `;

      // Voreintr√§ge √ºbernehmen
      const $ = sel => row.querySelector(sel);
      if (preset.fakultaet !== undefined) $('input[name^="einsatz_fakultaet_"]').value = preset.fakultaet;
      if (preset.stg !== undefined)       $('input[name^="einsatz_stg_"]').value       = preset.stg;
      if (preset.fs !== undefined)        $('input[name^="einsatz_fs_"]').value        = preset.fs;
      if (preset.gruppe !== undefined)    $('input[name^="einsatz_gruppe_"]').value    = preset.gruppe;
            if (preset.modulname !== undefined) $('input[name^="einsatz_modulname_"]').value = preset.modulname;
      if (preset.sws_v !== undefined)     $('input[name^="einsatz_sws_v_"]').value     = preset.sws_v;
      if (preset.sws_s !== undefined)     $('input[name^="einsatz_sws_s_"]').value     = preset.sws_s;
      if (preset.sws_p !== undefined)     $('input[name^="einsatz_sws_p_"]').value     = preset.sws_p;
      if (preset.digital !== undefined)   {
        const digSel = $('select[name^="einsatz_digital_"]');
        digSel.value = (preset.digital === true || preset.digital === 'ja') ? 'ja'
                     : (preset.digital === false || preset.digital === 'nein') ? 'nein' : '';
      }
      if (preset.bemerkung !== undefined) $('input[name^="einsatz_bemerkung_"]').value = preset.bemerkung;

      // Modulnr.-Select bef√ºllen + ggf. vorbelegen
      const selMod = row.querySelector('.modulnr-select');
      if (selMod) populateModulnrSelect(selMod, preset.modulnr);

      renumberEinsatzRows();
    }

    function removeEinsatzRow(btn) {
      const table = document.getElementById("einsatzTable");
      if (!table) return;
      if (table.rows.length <= 3) return; // 2 Header + 1 Datenzeile
      const row = btn.closest('tr');
      row.parentNode.removeChild(row);
      renumberEinsatzRows();
    }

    function renumberEinsatzRows() {
      const table = document.getElementById("einsatzTable");
      if (!table) return;

      let nummer = 1;
      for (let i = 2; i < table.rows.length; i++) {
        const row = table.rows[i];
        row.cells[0].textContent = nummer;
        row.querySelector('input[name^="einsatz_fakultaet_"]').name = "einsatz_fakultaet_" + nummer;
        row.querySelector('input[name^="einsatz_stg_"]').name = "einsatz_stg_" + nummer;
        row.querySelector('input[name^="einsatz_fs_"]').name = "einsatz_fs_" + nummer;
        row.querySelector('input[name^="einsatz_gruppe_"]').name = "einsatz_gruppe_" + nummer;
        row.querySelector('[name^="einsatz_modulnr_"]').name = "einsatz_modulnr_" + nummer;
        row.querySelector('input[name^="einsatz_modulname_"]').name = "einsatz_modulname_" + nummer;
        row.querySelector('input[name^="einsatz_sws_v_"]').name = "einsatz_sws_v_" + nummer;
        row.querySelector('input[name^="einsatz_sws_s_"]').name = "einsatz_sws_s_" + nummer;
        row.querySelector('input[name^="einsatz_sws_p_"]').name = "einsatz_sws_p_" + nummer;
        row.querySelector('select[name^="einsatz_digital_"]').name = "einsatz_digital_" + nummer;
        row.querySelector('input[name^="einsatz_bemerkung_"]').name = "einsatz_bemerkung_" + nummer;
        nummer++;
      }
    }
  </script>

  <!-- hinweise.js -->
  <script>
    let hinweisZaehler = 0;

    document.addEventListener("DOMContentLoaded", function() {
      document.getElementById("hinweisAddBtn").addEventListener("click", addHinweisRow);
      addHinweisRow();
    });

    function addHinweisRow() {
      const tableDiv = document.getElementById("hinweisTabelle");

      if (!document.getElementById("hinweisTable")) {
        tableDiv.innerHTML = `
          <table border="1" style="border-collapse:collapse;width:100%" id="hinweisTable">
            <tr>
              <th>Bei Bedarf vom Dozenten auszuf√ºllen</th>
              <th>Nur vom Dekanat / Studienamt auszuf√ºllen!</th>
              <th></th>
            </tr>
            <tr>
              <td><strong>Wichtige Hinweise zur Semesterplanung:</strong><br>Keine Sperrzeiten!!!</td>
              <td><strong>Hinweise bei R√ºckgabe an den Dozenten:</strong></td>
              <td></td>
            </tr>
          </table>
        `;
      }

      hinweisZaehler++;
      const table = document.getElementById("hinweisTable");
      const row = table.insertRow(-1);

      let dozentPlaceholder = "";
      if (hinweisZaehler === 1) {
        dozentPlaceholder = "z.B.: kein Dozententag, daf√ºr Gleichverteilung der LV";
      }

      row.innerHTML = `
        <td><input name="hinweis_dozent_${hinweisZaehler}" style="width:98%" placeholder="${dozentPlaceholder}"></td>
        <td><input name="hinweis_dekanat_${hinweisZaehler}" style="width:98%"></td>
        <td><button type="button" class="btn" onclick="removeHinweisRow(this)">üóëÔ∏è</button></td>
      `;
    }

    function removeHinweisRow(btn) {
      const row = btn.closest('tr');
      row.parentNode.removeChild(row);
    }
  </script>

  <!-- einsatzzeiten.js -->
  <script>
    let einsatzzeitZaehler = 0;

    document.addEventListener("DOMContentLoaded", function() {
      document.getElementById("einsatzzeitAddBtn").addEventListener("click", addEinsatzzeitRow);
      addEinsatzzeitRow();
    });

    function addEinsatzzeitRow() {
      const tableDiv = document.getElementById("einsatzzeitTabelle");

      if (!document.getElementById("einsatzzeitTable")) {
        tableDiv.innerHTML = `
          <table border="1" style="border-collapse:collapse;width:100%;" id="einsatzzeitTable">
            <tr>
              <th colspan="4">Zeitangabe</th>
              <th rowspan="2">Anmerkung</th>
              <th rowspan="2"></th>
            </tr>
            <tr>
              <th>Wochen<br><span style="font-weight:normal;">aw/gw/uw</span></th>
              <th>Wochentag<br><span style="font-weight:normal;">Mo/Di/Mi/Do/Fr</span></th>
              <th>Von</th>
              <th>Bis</th>
            </tr>
          </table>
        `;
      }

      einsatzzeitZaehler++;
      const table = document.getElementById("einsatzzeitTable");
      const row = table.insertRow(-1);

      row.innerHTML = `
        <td>
          <select name="einsatzzeit_wochen_${einsatzzeitZaehler}">
            <option value="">‚Äì w√§hlen ‚Äì</option>
            <option value="aw">aw</option>
            <option value="gw">gw</option>
            <option value="uw">uw</option>
          </select>
        </td>
        <td>
          <select name="einsatzzeit_wochentag_${einsatzzeitZaehler}">
            <option value="">‚Äì w√§hlen ‚Äì</option>
            <option value="Mo">Mo</option>
            <option value="Di">Di</option>
            <option value="Mi">Mi</option>
            <option value="Do">Do</option>
            <option value="Fr">Fr</option>
          </select>
        </td>
        <td>
          <select name="einsatzzeit_von_${einsatzzeitZaehler}">
            ${zeitOptionen()}
          </select>
        </td>
        <td>
          <select name="einsatzzeit_bis_${einsatzzeitZaehler}">
            ${zeitOptionen()}
          </select>
        </td>
        <td>
          <input name="einsatzzeit_anmerkung_${einsatzzeitZaehler}" style="width:98%">
        </td>
        <td>
          <button type="button" class="btn" onclick="removeEinsatzzeitRow(this)">üóëÔ∏è</button>
        </td>
      `;
    }

    function zeitOptionen() {
      let html = `<option value="">‚Äì w√§hlen ‚Äì</option>`;
      for (let h = 7; h <= 20; h++) {
        for (let m of [0, 15, 30, 45]) {
          const hh = String(h).padStart(2, '0');
          const mm = String(m).padStart(2, '0');
          html += `<option value="${hh}:${mm}">${hh}:${mm}</option>`;
        }
      }
      return html;
    }

    function removeEinsatzzeitRow(btn) {
      const row = btn.closest('tr');
      row.parentNode.removeChild(row);
    }
  </script>

  <!-- sperrzeiten.js -->
  <script>
    let sperrzeitZaehler = 0;

    document.addEventListener("DOMContentLoaded", function() {
      document.getElementById("sperrzeitAddBtn").addEventListener("click", addSperrzeitRow);
      addSperrzeitRow();
    });

    function addSperrzeitRow() {
      const tableDiv = document.getElementById("sperrzeitTabelle");

      if (!document.getElementById("sperrzeitTable")) {
        tableDiv.innerHTML = `
          <table border="1" style="border-collapse:collapse;width:100%;" id="sperrzeitTable">
            <tr>
              <th colspan="3">Zeitangabe</th>
              <th rowspan="2">Begr√ºndung</th>
              <th rowspan="2"></th>
            </tr>
            <tr>
              <th>Wochen<br><span style="font-weight:normal;">aw/gw/uw</span></th>
              <th>Wochentag<br><span style="font-weight:normal;">Mo/Di/Mi/Do/Fr</span></th>
              <th>Uhrzeit<br><span style="font-weight:normal;">Bis/Ab</span></th>
            </tr>
          </table>
        `;
      }

      sperrzeitZaehler++;
      const table = document.getElementById("sperrzeitTable");
      const row = table.insertRow(-1);

      row.innerHTML = `
        <td>
          <select name="sperrzeit_wochen_${sperrzeitZaehler}">
            <option value="">‚Äì w√§hlen ‚Äì</option>
            <option value="aw">aw</option>
            <option value="gw">gw</option>
            <option value="uw">uw</option>
          </select>
        </td>
        <td>
          <select name="sperrzeit_wochentag_${sperrzeitZaehler}">
            <option value="">‚Äì w√§hlen ‚Äì</option>
            <option value="Mo">Mo</option>
            <option value="Di">Di</option>
            <option value="Mi">Mi</option>
            <option value="Do">Do</option>
            <option value="Fr">Fr</option>
          </select>
        </td>
        <td>
          <select name="sperrzeit_bisab_${sperrzeitZaehler}">
            <option value="">‚Äì w√§hlen ‚Äì</option>
            <option value="Bis 07:00">Bis 07:00</option>
            <option value="Bis 08:00">Bis 08:00</option>
            <option value="Bis 09:00">Bis 09:00</option>
            <option value="Ab 15:00">Ab 15:00</option>
            <option value="Ab 16:00">Ab 16:00</option>
            <option value="Ab 17:00">Ab 17:00</option>
          </select>
        </td>
        <td>
          <input name="sperrzeit_begruendung_${sperrzeitZaehler}" style="width:98%">
        </td>
        <td>
          <button type="button" class="btn" onclick="removeSperrzeitRow(this)">üóëÔ∏è</button>
        </td>
      `;
    }

    function removeSperrzeitRow(btn) {
      const row = btn.closest('tr');
      row.parentNode.removeChild(row);
    }
  </script>

  <!-- dozentforschungstag.js -->
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      erstelleDFTagTabelle();
    });

    function erstelleDFTagTabelle() {
      const tableDiv = document.getElementById("dfTagTabelle");
      tableDiv.innerHTML = `
        <table border="1" style="border-collapse:collapse; text-align:center; width:100%;">
          <tr>
            <th>Tag ist egal</th>
            <th>Montag</th>
            <th>Dienstag</th>
            <th>Mittwoch</th>
            <th>Donnerstag</th>
            <th>Freitag</th>
          </tr>
          <tr>
            <td>
              <label><input type="checkbox" name="df_tag_egal_D" value="D"> D</label>
              <label><input type="checkbox" name="df_tag_egal_F" value="F"> F</label>
            </td>
            <td>
              <label><input type="checkbox" name="df_mo_D" value="D"> D</label>
              <label><input type="checkbox" name="df_mo_F" value="F"> F</label>
            </td>
            <td>
              <label><input type="checkbox" name="df_di_D" value="D"> D</label>
              <label><input type="checkbox" name="df_di_F" value="F"> F</label>
            </td>
            <td>
              <label><input type="checkbox" name="df_mi_D" value="D"> D</label>
              <label><input type="checkbox" name="df_mi_F" value="F"> F</label>
            </td>
            <td>
              <label><input type="checkbox" name="df_do_D" value="D"> D</label>
              <label><input type="checkbox" name="df_do_F" value="F"> F</label>
            </td>
            <td>
              <label><input type="checkbox" name="df_fr_D" value="D"> D</label>
              <label><input type="checkbox" name="df_fr_F" value="F"> F</label>
            </td>
          </tr>
          <tr style="background:#f8fff8;">
            <td>
              <label><input type="checkbox" name="df_not_egal_D" value="D"> D</label>
              <label><input type="checkbox" name="df_not_egal_F" value="F"> F</label>
            </td>
            <td>
              <label><input type="checkbox" name="df_not_mo_D" value="D"> D</label>
              <label><input type="checkbox" name="df_not_mo_F" value="F"> F</label>
            </td>
            <td>
              <label><input type="checkbox" name="df_not_di_D" value="D"> D</label>
              <label><input type="checkbox" name="df_not_di_F" value="F"> F</label>
            </td>
            <td>
              <label><input type="checkbox" name="df_not_mi_D" value="D"> D</label>
              <label><input type="checkbox" name="df_not_mi_F" value="F"> F</label>
            </td>
            <td>
              <label><input type="checkbox" name="df_not_do_D" value="D"> D</label>
              <label><input type="checkbox" name="df_not_do_F" value="F"> F</label>
            </td>
            <td>
              <label><input type="checkbox" name="df_not_fr_D" value="D"> D</label>
              <label><input type="checkbox" name="df_not_fr_F" value="F"> F</label>
            </td>
          </tr>
        </table>
      `;
    }
  </script>

  <!-- =========================
       Modul-JSON laden & Autofill-Logik
       ========================= -->
  <script>
    let MODULES = [];
    const modulesById = {};

    function nf(x){ const n = Number(x); return Number.isFinite(n) ? Math.max(0, n) : ''; }
    function inferDigital(mod){
      const d = (mod?.CharakterLehrveranstaltung?.Durchf√ºhrung || '').toLowerCase();
      if (!d) return '';
      if (d.includes('pr√§senz') || d.includes('praesenz')) return 'nein';
      if (d.includes('online') || d.includes('digital')) return 'ja';
      return '';
    }
    function inferStudiengang(mod, auf){
      const g = (auf && typeof auf.Gruppen === 'string') ? auf.Gruppen : '';
      if (g.includes('INB')) return 'INB';
      if (g.includes('MIB')) return 'MIB';
      if (Array.isArray(mod?.ZusammenMit) && mod.ZusammenMit.length) return mod.ZusammenMit.join('+');
      return '';
    }

    function fillModuleSelect(list){
      const sel = document.getElementById('modulSelect');
      sel.innerHTML = '';
      list.forEach(m => {
        const opt = document.createElement('option');
        opt.value = m.Modulnummer;
        const fs = m.Fachsemester ? `, FS ${m.Fachsemester}` : '';
        const turn = m.Turnus ? `, ${m.Turnus}` : '';
        opt.textContent = `${m.Modulnummer} ‚Äî ${m.Modulbezeichnung}${fs}${turn}`;
        const searchBlob = [m.Modulnummer, m.Modulbezeichnung, (m.ZusammenMit||[]).join(' '), m?.Modulverantwortliche?.Vorname, m?.Modulverantwortliche?.Nachname].filter(Boolean).join(' ').toLowerCase();
        opt.dataset.search = searchBlob;
        sel.appendChild(opt);
      });
      // Doppelklick √ºbernimmt direkt
      sel.addEventListener('dblclick', () => applySelectedModule());
    }

    async function loadModules(){
      try {
        // 1) Prim√§r: vom Backend holen (deine Datei nutzt /api/module)
        const res = await fetch('/api/module', { headers: { 'Accept': 'application/json' } });
        if (!res.ok) throw new Error('HTTP '+res.status);
        MODULES = await res.json();
      } catch (apiErr) {
        try {
          // 2) Fallback: eingebettetes JSON im Dokument
          const embedded = document.getElementById('moduleJson');
          if (embedded) {
            MODULES = JSON.parse(embedded.textContent);
          } else {
            // 3) Fallback: statische Datei /modules.json
            const res2 = await fetch('/modules.json');
            if (!res2.ok) throw new Error('HTTP '+res2.status);
            MODULES = await res2.json();
          }
        } catch (fallbackErr) {
          console.error('Module konnten nicht geladen werden:', apiErr, fallbackErr);
          MODULES = [];
        }
      }

      MODULES.forEach(m => { modulesById[m.Modulnummer] = m; });

      // Fakult√§tsliste mit JSON-Werten anreichern
      const extraFaks = Array.from(new Set(MODULES.map(m => m.Fakult√§t).filter(Boolean)));
      extraFaks.forEach(f => { if (!fakultaetListe.includes(f)) fakultaetListe.push(f); });
      fillFakultaetList();

      if (document.getElementById('modulSelect')) fillModuleSelect(MODULES);

      populateAllModulnrSelects();
    }

    function applySelectedModule(){
      const sel = document.getElementById('modulSelect');
      const id = sel.value;
      if (!id) return;
      const mod = modulesById[id];
      if (!mod) return;
      applyModule(mod);
    }

    function applyModule(mod){
      ensureEinsatzTable();
      clearEinsatzTable();

      // Zusammenfassungs-Zeile
      addEinsatzRow({
        fakultaet: mod.Fakult√§t || '',
        stg: (Array.isArray(mod.ZusammenMit) && mod.ZusammenMit.length) ? mod.ZusammenMit.join('+') : '',
        fs: mod.Fachsemester || '',
        gruppe: '',
        modulnr: mod.Modulnummer,
        modulname: mod.Modulbezeichnung,
        sws_v: nf(mod?.Lehrveranstaltungen?.SWS_V),
        sws_s: nf(mod?.Lehrveranstaltungen?.SWS_S),
        sws_p: nf(mod?.Lehrveranstaltungen?.SWS_P),
        digital: inferDigital(mod),
        bemerkung: [mod.Turnus, mod.Niveau].filter(Boolean).join(' ‚Ä¢ ')
      });

      // Detail-Zeilen aus Aufteilung (falls vorhanden)
      const auf = mod?.Lehrveranstaltungen?.Aufteilung;
      if (Array.isArray(auf) && auf.length){
        auf.forEach(a => {
          addEinsatzRow({
            fakultaet: mod.Fakult√§t || '',
            stg: inferStudiengang(mod, a),
            fs: mod.Fachsemester || '',
            gruppe: a.Gruppen || '',
            modulnr: mod.Modulnummer,
            modulname: `${mod.Modulbezeichnung} ‚Äî ${a.Typ || ''}`.trim(),
            sws_v: a?.Typ?.toLowerCase().startsWith('vorlesung') ? nf(a.SWS) : '',
            sws_s: a?.Typ?.toLowerCase().startsWith('seminar')   ? nf(a.SWS) : '',
            sws_p: a?.Typ?.toLowerCase().startsWith('praktikum') ? nf(a.SWS) : '',
            digital: inferDigital(mod),
            bemerkung: [a.Dozent, a.Gruppenanzahl ? `Gruppen: ${a.Gruppenanzahl}` : ''].filter(Boolean).join(' ‚Ä¢ ')
          });
        });
      }

      // Semester passend zum Turnus w√§hlen
      if (mod?.Turnus) setSemesterFromTurnus(mod.Turnus);

      alert('Moduldaten √ºbernommen.');
    }

    // Filter-UI
    document.addEventListener('DOMContentLoaded', () => {
      const filter = document.getElementById('moduleFilter');
      const sel = document.getElementById('modulSelect');
      const applyBtn = document.getElementById('applyModuleBtn');
      if (filter && sel) {
        filter.addEventListener('input', () => {
          const q = filter.value.trim().toLowerCase();
          Array.from(sel.options).forEach(opt => {
            opt.hidden = q && !opt.dataset.search.includes(q);
          });
        });
        sel.addEventListener('dblclick', () => applySelectedModule());
      }
      if (applyBtn) applyBtn.addEventListener('click', applySelectedModule);
    });

    // Start: Module laden
    document.addEventListener('DOMContentLoaded', loadModules);
  </script>

  <!-- Optional: Wenn du die JSON lokal einbetten willst, f√ºge sie so ein (ansonsten entfernen):
  <script type="application/json" id="moduleJson">[ /* ‚Ä¶ deine Module ‚Ä¶ */ ]</script>
  -->
  <script>
    // Modulnr.-Selects bef√ºllen + Row-Autofill
    function populateModulnrSelect(sel, preset) {
      if (!sel) return;
      const current = sel.value;
      sel.innerHTML = '<option value="">‚Äì w√§hlen ‚Äì</option>';
      (Array.isArray(MODULES) ? MODULES : []).forEach(function(m){
        var opt = document.createElement('option');
        opt.value = m.Modulnummer;
        opt.textContent = m.Modulnummer + ' ‚Äî ' + m.Modulbezeichnung;
        sel.appendChild(opt);
      });
      if (preset) sel.value = preset; else if (current) sel.value = current;
    }

    function populateAllModulnrSelects(){
      document.querySelectorAll('.modulnr-select').forEach(function(sel){
        populateModulnrSelect(sel);
      });
    }

    function setIfEmpty(input, value){
      if (input && !input.value && value != null) input.value = value;
    }
    function setFakultaetIfEmpty(value){
      var sel = document.getElementById('fakultaet');
      if (!sel || !value) return;
      if (!sel.value){
        if (!Array.from(sel.options).some(function(o){ return o.value === value; })){
          var o = document.createElement('option'); o.value = value; o.textContent = value; sel.appendChild(o);
        }
        sel.value = value;
      }
    }

    function fillRowFromModule(row, mod){
      function q(s){ return row.querySelector(s); }
      setIfEmpty(q('input[name^="einsatz_fakultaet_"]'), mod.Fakult√§t || '');
      setIfEmpty(q('input[name^="einsatz_stg_"]'), (Array.isArray(mod.ZusammenMit) && mod.ZusammenMit.length) ? mod.ZusammenMit.join('+') : '');
      setIfEmpty(q('input[name^="einsatz_fs_"]'), mod.Fachsemester || '');
      setIfEmpty(q('input[name^="einsatz_gruppe_"]'), '');
      setIfEmpty(q('input[name^="einsatz_modulname_"]'), mod.Modulbezeichnung || '');
      setIfEmpty(q('input[name^="einsatz_sws_v_"]'), (mod && mod.Lehrveranstaltungen && mod.Lehrveranstaltungen.SWS_V != null) ? mod.Lehrveranstaltungen.SWS_V : '');
      setIfEmpty(q('input[name^="einsatz_sws_s_"]'), (mod && mod.Lehrveranstaltungen && mod.Lehrveranstaltungen.SWS_S != null) ? mod.Lehrveranstaltungen.SWS_S : '');
      setIfEmpty(q('input[name^="einsatz_sws_p_"]'), (mod && mod.Lehrveranstaltungen && mod.Lehrveranstaltungen.SWS_P != null) ? mod.Lehrveranstaltungen.SWS_P : '');
      var digSel = q('select[name^="einsatz_digital_"]');
      if (digSel && !digSel.value){
        var d = (mod && mod.CharakterLehrveranstaltung && mod.CharakterLehrveranstaltung.Durchf√ºhrung ? mod.CharakterLehrveranstaltung.Durchf√ºhrung : '').toLowerCase();
        digSel.value = (d.indexOf('online') >= 0 || d.indexOf('digital') >= 0) ? 'ja' : ((d.indexOf('pr√§senz') >= 0 || d.indexOf('praesenz') >= 0) ? 'nein' : '');
      }
      setIfEmpty(q('input[name^="einsatz_bemerkung_"]'), [mod.Turnus, mod.Niveau].filter(Boolean).join(' ‚Ä¢ '));

      // globale Felder sanft vorbelegen (nur wenn leer)
      setFakultaetIfEmpty(mod.Fakult√§t || '');
      if (mod && mod.Turnus) setSemesterFromTurnus(mod.Turnus);
      var mv = (mod && mod.Modulverantwortliche) ? mod.Modulverantwortliche : {};
      setIfEmpty(document.querySelector('input[name="vorname"]'), mv.Vorname);
      setIfEmpty(document.querySelector('input[name="name"]'), mv.Nachname);
    }

    // Delegiertes Change-Event: jedes Modulnr-Select triggert Autofill
    document.addEventListener('change', function(e){
      if (e.target && e.target.classList && e.target.classList.contains('modulnr-select')){
        var mod = modulesById[e.target.value];
        var row = e.target.closest('tr');
        if (mod && row) fillRowFromModule(row, mod);
      }
    });

    // Nach DOM + nach Laden der Module die Selects f√ºllen
    document.addEventListener('DOMContentLoaded', function(){
      populateAllModulnrSelects();
    });
  </script>
</body>
</html>
